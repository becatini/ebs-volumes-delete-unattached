# Delete EBS Volumes Unattached for More Than 45 Days

The repository contains the code to delete all the EBS volumes unattached for more than 45 days.

This is useful for an environment with multiple AWS accounts with multiple volumes on different regions.

## The Tool

This bash script will read a CSV file generated by the repository https://github.com/becatini/ebs-volumes_unattached.

Essentially, it will access CloudTrail and look for events that indicate when the volume was unattached.

If the volume was unattached for more than 45 days, or there is no event, the unattached volume will be deleted. 

## Diagram

```mermaid
flowchart TD
    A1((Start Job)) --> C1{For Each Unattached Volume}

    C1 -- "Read list" --> B1([**Unattached Volumes List**])    
    C1 -- "Read volume" --> D1[Check account]
    
    D1 -- "Change Account" --> D5[Log New Account]
    D5 --> D2[Assume Role]
    D2 -- "Access Denied" --> D3[Log NOK - Skip account]
    D3 --> C1
    D2 -- "Access Granted" --> D4[Log OK - Set credentials]
    D1 -- "Same Account" --> D2
        
    D4 --> E1[Check if processing a new region]
    E1 -- "Change Region" --> E2[Log new region]
    E1 -- "Same Region" --> F1[Check CloudTrail for DetachVolume Event]
    E2 --> F1
    
    F1 -- "Found Event" --> G3{Time > 45 days?}
    G3 -- "Yes" --> H1[Log: Delete Volume]
    G3 -- "No" --> H2[Log: Don't Delete Volume]
    
    F1 -- "No Event" --> I1[Log: No Event in CloudTrail]
    I1 --> H1

    H1 -.-> C1
    H2 -.-> C1
    I1 -.-> C1
    
    C1 -- "End of file" --> Z1[End Job]
```
